(function($){"use strict";var pluginName='cocoAjaxMultiSelect',page=1,searchtext=null,termTimeout=null,selectedval,canScrollAjax=!0,viewCnt=0,defaults={'ajaxCode':function(input,page,pagging){alert('ERROR! ajaxfunc 옵션을 반드시 작성해주세요!');throw "stop"},checkedCode:function(selectValue){console.log(selectValue)},'arrayInKey':'uuid','arrayInValue':'name','regularExpression':'[a-z|A-Z|가-힣| ]{2,}','delay':700,'pageUnit':20,'scrollLeftLoad':100,'height':300};function cocoAjaxMultiSelect(element,options){this.element=element;this.$element=$(element);this.settings=$.extend({},defaults,options);this._defaults=defaults;this._name=pluginName;this.init()};$.extend(cocoAjaxMultiSelect.prototype,{init:function(){let id=$(this.element).attr('id');let value=$(this.element).val();let multiple=$(this.element).attr('multiple');$(this.element).after("<label for='"+id+"'></label>");$("label[for='"+id+"']").after("<s for='"+id+"'></s>");if(multiple=='multiple'){if(value!=''){$("s[for='"+id+"']").text(value.split(',').length)}else{$("s[for='"+id+"']").hide();$("s[for='"+id+"']").text('')}}else{$("s[for='"+id+"']").hide()}
this.clickListener();this.closeListener();this.inputListener();this.holdonFocus();this.checkboxControl()},checkboxControl:function(){var _this=this;let multiple=this.$element.attr('multiple');$('html').on('click.cocoAjaxMultiSelect',".ajaxselect_detail[for='"+this.$element.attr('id')+"'] input",function(){let is_checked=$(this).attr('checked');let value=$(this).next('label').text();if(is_checked=='checked'){if(multiple){for(let i=0;i<selectedval.length;i++){if(selectedval[i]===value){selectedval.splice(i,1);i--}}}}else{if(multiple){selectedval.push(value)}else{selectedval=new Array(value)}}
_this.settings.checkedCode(selectedval)})},detailshow:function(id,data_arr,multiple,width,top,left){let type='checkbox';if(multiple){type='checkbox'}else{type='radio'}
let detail_li='';if($(".ajaxselect_detail[for='"+id+"']").length==0){detail_li+="<ul for='"+id+"' class='ajaxselect_detail' style='max-height:"+this.settings.height+"'>"}
viewCnt=0;if(data_arr.length>0){for(let i=0;i<data_arr.length;i++){if(selectedval.includes(data_arr[i][String(this.settings.arrayInValue)])){detail_li+="<li><input type='"+type+"' name='"+id+"' id='"+data_arr[i][String(this.settings.arrayInKey)]+"' checked /><label for='"+data_arr[i][String(this.settings.arrayInKey)]+"'>"+data_arr[i][String(this.settings.arrayInValue)]+"</label></li>"}else{detail_li+="<li><input type='"+type+"' name='"+id+"' id='"+data_arr[i][String(this.settings.arrayInKey)]+"' /><label for='"+data_arr[i][String(this.settings.arrayInKey)]+"'>"+data_arr[i][String(this.settings.arrayInValue)]+"</label></li>"}
viewCnt++}}else{viewCnt++;detail_li+="<li><article>검색결과가 없습니다</article></li>"}
if($(".ajaxselect_detail[for='"+id+"']").length==0){detail_li+="</ul>";$("s[for='"+id+"']").after(detail_li)}else{$(".ajaxselect_detail[for='"+id+"']").html(detail_li)}
var _this=this;var id=$(this.element).attr('id');$(".ajaxselect_detail[for='"+id+"']").scroll(function(){return new Promise(function(resolve,reject){let scrollTop=$(".ajaxselect_detail[for='"+id+"']").scrollTop();let detailViewHeight=_this.settings.height;let resultViewHeight=$(".ajaxselect_detail[for='"+id+"'] li").outerHeight()*viewCnt;if(canScrollAjax&&scrollTop+_this.settings.scrollLeftLoad>=resultViewHeight-detailViewHeight&&viewCnt>=_this.settings.pageUnit){page++;_this.settings.ajaxCode(searchtext,page,_this.settings.pageUnit).then((data)=>{if(data.length>0){_this.moreshow(id,data,type).then(()=>{resolve()}).catch(function(err){if(termTimeout!=null){clearTimeout(termTimeout)}
canScrollAjax=!1})}else{canScrollAjax=!1}})}})});$(".ajaxselect_detail[for='"+id+"']").css({top:top,left:left,width:width});$("s[for='"+id+"']").hide()},moreshow:function(id,data_arr,type){var _this=this;let data_lengh=data_arr.length;return new Promise(function(resolve,reject){if(data_lengh>0&&canScrollAjax){canScrollAjax=!1;viewCnt=data_lengh+viewCnt;let more_detail_li='';for(let i=0;i<data_lengh;i++){if(selectedval.includes(data_arr[i][String(_this.settings.arrayInValue)])){more_detail_li+="<li><input type='"+type+"' name='"+id+"' id='"+data_arr[i][String(_this.settings.arrayInKey)]+"' checked /><label for='"+data_arr[i][String(_this.settings.arrayInKey)]+"'>"+data_arr[i][String(_this.settings.arrayInValue)]+"</label></li>"}else{more_detail_li+="<li><input type='"+type+"' name='"+id+"' id='"+data_arr[i][String(_this.settings.arrayInKey)]+"' /><label for='"+data_arr[i][String(_this.settings.arrayInKey)]+"'>"+data_arr[i][String(_this.settings.arrayInValue)]+"</label></li>"}}
$(".ajaxselect_detail[for='"+id+"']").append(more_detail_li).promise().done(function(){if(data_lengh>=_this.settings.pageUnit){canScrollAjax=!0;resolve()}else{canScrollAjax=!1;reject()}})}})},clickListener:function(){var _this=this;$('html').on('click.cocoAjaxMultiSelect',"#"+this.$element.attr('id')+"[type='cocoAjaxMultiSelect']",function(){let focus=$(this).attr('focus');let id=$(this).attr('id');let multiple=$(this).attr('multiple');if(multiple=='multiple'){multiple=!0}else{multiple=!1}
let value=$(this).val();if(value!=''){selectedval=value.split(',');searchtext=null}else{selectedval=new Array()}
if(typeof focus=='undefined'||focus==null||focus==''){$(this).attr('autocomplete','off');$(this).val('');$(this).attr('readonly',!1);$(this).attr('focus','on');_this.settings.ajaxCode(searchtext,page,_this.settings.pageUnit).then((data)=>{_this.$element.before("<div for='"+id+"' class='ajaxselect_over'></div>");_this.detailshow(id,data,multiple,$(this).outerWidth()-30,$(this).offset().top+32,$(this).offset().left);if(data.length>=_this.settings.pageUnit){canScrollAjax=!0}else{canScrollAjax=!1}})}})},closeListener:function(){let multiple=this.$element.attr('multiple');$('html').on('click.cocoAjaxMultiSelect',".ajaxselect_over[for='"+this.$element.attr('id')+"']",function(){let overfor=$(this).attr('for');if(typeof overfor!='undefined'&&overfor!=null&&overfor!=''){let values='';for(var i=0;i<selectedval.length;i++){values+=selectedval[i];if(i<selectedval.length-1){values+=','}}
$("#"+String(overfor)+"[type='cocoAjaxMultiSelect']").val(values);if(multiple=='multiple'){if(selectedval.length>0){$("s[for='"+overfor+"']").text(selectedval.length);$("s[for='"+overfor+"']").show()}else{$("s[for='"+overfor+"']").hide()}}else{$("s[for='"+overfor+"']").hide()}
$("input[type='cocoAjaxMultiSelect']").removeAttr('focus');$("input[type='cocoAjaxMultiSelect']").attr('readonly',!0);$(".ajaxselect_detail[for='"+overfor+"']").remove();$(".ajaxselect_over[for='"+overfor+"']").remove()}
page=1;canScrollAjax=!0;searchtext=null;$(this).remove()})},inputListener:function(){var _this=this;let inputReg=new RegExp(this.settings.regularExpression,'g');$('html').on('keypress.cocoAjaxMultiSelect',"#"+this.$element.attr('id')+"[type='cocoAjaxMultiSelect']",function(e){let keycode=e.keyCode;if(keycode==13){if(termTimeout!=null){clearTimeout(termTimeout)}
page=1;let focus=$(this).attr('focus');let id=$(this).attr('id');let multiple=$(this).attr('multiple');if(multiple=='multiple'){multiple=!0}else{multiple=!1}
if(focus=='on'){_this.settings.ajaxCode($(this).val(),page,_this.settings.pageUnit).then((data)=>{searchtext=$(this).val();_this.detailshow(id,data,multiple,$(this).outerWidth()-30,$(this).offset().top+32,$(this).offset().left);if(data.length>=_this.settings.pageUnit){canScrollAjax=!0}else{canScrollAjax=!1}})}}});$('html').on('input.cocoAjaxMultiSelect',"#"+this.$element.attr('id')+"[type='cocoAjaxMultiSelect']",function(event){page=1;let focus=$(this).attr('focus');let id=$(this).attr('id');let multiple=$(this).attr('multiple');if(multiple=='multiple'){multiple=!0}else{multiple=!1}
if(focus=='on'){if(termTimeout!=null){clearTimeout(termTimeout)}
var keypromise=new Promise((resolve,reject)=>{if(inputReg.test($(this).val())||$(this).val()==''){termTimeout=setTimeout(function(){termTimeout=null;resolve()},_this.settings.delay)}else{reject()}});keypromise.then(()=>{_this.settings.ajaxCode($(this).val(),page,_this.settings.pageUnit).then((data)=>{searchtext=$(this).val();_this.detailshow(id,data,multiple,$(this).outerWidth()-30,$(this).offset().top+32,$(this).offset().left);if(data.length>=_this.settings.pageUnit){canScrollAjax=!0}else{canScrollAjax=!1}})}).catch(function(err){if(termTimeout!=null){clearTimeout(termTimeout)}
canScrollAjax=!0;searchtext=null})}else{if(termTimeout!=null){clearTimeout(termTimeout)}
var key=event.keyCode;if(key!=''){event.returnValue=!1}
canScrollAjax=!0;searchtext=null;$(this).blur()}})},holdonFocus:function(){$('html').on('blur.cocoAjaxMultiSelect',"#"+this.$element.attr('id')+"[type='cocoAjaxMultiSelect']",function(){if($(this).attr('focus')=='on'){$(this).focus()}})}});$.fn[pluginName]=function(options){return this.each(function(){if(!$.data(this,"plugin_"+pluginName)){$.data(this,"plugin_"+pluginName,new cocoAjaxMultiSelect(this,options))}})}})(jQuery)